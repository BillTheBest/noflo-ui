<link rel="import" href="noflo-main.html">
<link rel="import" href="../bower_components/the-graph/the-graph-editor/the-graph-editor.html">
<link rel="import" href="noflo-library.html">
<link rel="import" href="noflo-context.html">
<link rel="import" href="noflo-runtime.html">
<link rel="import" href="noflo-journal.html">
<link rel="import" href="noflo-component-editor.html">
<link rel="import" href="noflo-search.html">
<link rel="import" href="noflo-project.html">
<link rel="import" href="noflo-packets.html">
<polymer-element name="noflo-ui" attributes="width height">
  <template>
    <style>
      the-graph-editor {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }

      noflo-component-editor {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 36px;
        right: 0;
        z-index: 0;
      }
    </style>
    <noflo-main id="main"></noflo-main>
    <the-graph-editor id="grapheditor" width="{{ width }}" height="{{ height }}"></the-graph-editor>
    <noflo-library id="library"></noflo-library>
    <noflo-context id="context"></noflo-context>
    <noflo-runtime id="runtime"></noflo-runtime>
    <noflo-journal id="journal"></noflo-journal>
    <noflo-component-editor id="componenteditor" width="{{ width }}" height="{{ height }}"></noflo-component-editor>
    <noflo-search id="search"></noflo-search>
    <noflo-project id="project"></noflo-project>
    <noflo-packets id="packets"></noflo-packets>
  </template>
  <script>
    Polymer('noflo-ui', {
      width: window.innerWidth,
      height: window.innerHeight,
      ctx: {},
      runtimes: function (runtimes) {
        runtimes.forEach(this.$.main.runtimes.bind(this.$.main));
      },
      projects: function (projects) {
        projects.forEach(this.$.main.projects.bind(this.$.main));
      },
      ready: function () {
        this.$.main.addEventListener('logout', function (event) {
          this.fire('user:logout', true);
        }.bind(this));
        this.$.main.addEventListener('login', function (event) {
          this.fire('user:login', true);
        }.bind(this));
        this.$.grapheditor.addEventListener('edges', function (event) {
          this.fire('context:edges', event.detail);
        }.bind(this));
        this.$.grapheditor.addEventListener('nodes', function (event) {
          this.fire('context:nodes', event.detail);
        }.bind(this));
        this.$.search.addEventListener('search', function (event) {
          this.fire('context:search', event.detail);
        }.bind(this));
        this.$.library.addEventListener('result', function (event) {
          this.fire('context:search_result', {
            searchResult: event.detail
          });
        }.bind(this));
        this.$.library.editor = this.$.grapheditor;
        this.$.journal.editor = this.$.grapheditor;
        this.$.context.editor = this.$.grapheditor;
        this.$.runtime.panel = this.$.context.$.fixed;
        this.$.packets.panel = this.$.context.$.context;
        this.$.search.panel = this.$.context.$.context;
      },
      context: function (context) {
        if (context.state) {
          console.log('CTX is', context);
        }
        for (var key in context) {
          this.ctx[key] = context[key];
        }
        if (context.projects) {
          this.projects(context.projects);
        }
        if (context.runtimes) {
          this.runtimes(context.runtimes);
        }
        if (context.search !== undefined) {
          this.$.library.search = {
            search: this.ctx.search
          };
        }
        if (context.searchResult) {
          this.$.search.results(this.ctx.searchResult);
        }
        if (this.ctx.edges) {
          this.$.packets.edges = this.ctx.edges;
        }
        if (this.ctx.nodes) {
          this.$.context.nodes = this.ctx.nodes;
        }
        if (this.ctx.nodes || this.ctx.edges) {
          return;
        }
        if (this.ctx.componentDefinition) {
          this.$.grapheditor.registerComponent(this.ctx.componentDefinition);
        }
        if (this.ctx.state === 'loading') {
          return;
        }
        if (this.ctx.state === 'error') {
          this.showError(this.ctx);
          return;
        }
        if (this.ctx.graphs.length || this.ctx.component) {
          this.$.main.open = false;
        } else {
          this.$.main.open = true;
        }
        if (this.ctx.graphs.length) {
          this.$.grapheditor.graph = this.ctx.graphs[this.ctx.graphs.length - 1];
          this.$.project.graph = this.ctx.graphs[this.ctx.graphs.length - 1];
          this.$.packets.currentgraph = this.ctx.graphs[this.ctx.graphs.length - 1];
          this.$.journal.graph = this.ctx.graphs[this.ctx.graphs.length - 1];
          this.$.runtime.graph = this.ctx.graphs[0];
          this.$.runtime.runtimes = this.ctx.compatibleRuntimes;
          this.$.runtime.runtime = this.ctx.runtime;
        } else {
          this.$.project.graph = null;
          this.$.journal.graph = null;
          this.$.runtime.graph = null;
        }
        this.$.context.graphs = this.ctx.graphs;
        this.$.library.graphs = this.ctx.graphs;
        this.$.project.graphs = this.ctx.graphs;
        this.$.project.component = this.ctx.component;
        this.$.project.project = this.ctx.project;
        this.$.componenteditor.component = this.ctx.component;
        this.$.search.graphs = this.ctx.graphs;
        this.$.search.component = this.ctx.component;
        this.$.search.project = this.ctx.project;
      },
      user: function (user) {
        this.$.main.githubToken = user['github-token'];
        this.$.project.githubtoken = user['github-token'];
        this.$.main.gridToken = user['grid-token'];
        this.$.main.user = user['grid-user'];
        this.$.main.avatar = user['grid-avatar'];
        this.$.main.plan = user['flowhub-plan'];
      },
      showError: function (ctx) {
      }
    });
  </script>
</polymer-element>
