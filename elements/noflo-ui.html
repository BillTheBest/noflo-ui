<link rel="import" href="noflo-main.html">
<link rel="import" href="../bower_components/the-graph/the-graph-editor/the-graph-editor.html">
<link rel="import" href="noflo-library.html">
<link rel="import" href="noflo-context.html">
<link rel="import" href="noflo-runtime.html">
<link rel="import" href="noflo-journal.html">
<link rel="import" href="noflo-component-editor.html">
<link rel="import" href="noflo-search.html">
<link rel="import" href="noflo-project.html">
<link rel="import" href="noflo-packets.html">
<polymer-element name="noflo-ui" attributes="width height">
  <template>
    <style>
      the-graph-editor {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }

      noflo-component-editor {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 36px;
        right: 0;
        z-index: 0;
      }
    </style>
    <noflo-main id="main"></noflo-main>
    <the-graph-editor id="grapheditor" width="{{ width }}" height="{{ height }}"></the-graph-editor>
    <noflo-library></noflo-library>
    <noflo-runtime id="runtime"></noflo-runtime>
    <noflo-journal id="journal"></noflo-journal>
    <noflo-component-editor id="componenteditor" width="{{ width }}" height="{{ height }}"></noflo-component-editor>
    <noflo-search id="search"></noflo-search>
    <noflo-project id="project"></noflo-project>
    <noflo-packets></noflo-packets>
  </template>
  <script>
    Polymer('noflo-ui', {
      width: window.innerWidth,
      height: window.innerHeight,
      runtimes: function (runtimes) {
        runtimes.forEach(this.$.main.runtimes.bind(this.$.main));
      },
      projects: function (projects) {
        projects.forEach(this.$.main.projects.bind(this.$.main));
      },
      ready: function () {
        this.$.main.addEventListener('logout', function (event) {
          this.fire('user:logout', true);
        }.bind(this));
        this.$.main.addEventListener('login', function (event) {
          this.fire('user:login', true);
        }.bind(this));
        this.$.search.addEventListener('search', function (event) {
          this.fire('search', event.detail.search);
        }.bind(this));
        this.$.journal.editor = this.$.grapheditor;
      },
      context: function (context) {
        console.log('CTX is', context);
        if (context.state !== 'ok') {
          return;
        }
        if (context.graphs.length || context.component) {
          this.$.main.open = false;
        } else {
          this.$.main.open = true;
        }
        if (context.graphs.length) {
          this.$.grapheditor.graph = context.graphs[context.graphs.length - 1];
          this.$.project.graph = context.graphs[context.graphs.length - 1];
          this.$.journal.graph = context.graphs[context.graphs.length - 1];
          this.$.runtime.graph = context.graphs[0];
        } else {
          this.$.project.graph = null;
          this.$.journal.graph = null;
          this.$.runtime.graph = null;
        }
        this.$.project.graphs = context.graphs;
        this.$.project.component = context.component;
        this.$.project.project = context.project;
        this.$.componenteditor.component = context.component;
        this.$.search.graphs = context.graphs;
        this.$.search.component = context.component;
        this.$.search.project = context.project;
      },
      user: function (user) {
        this.$.main.githubToken = user['github-token'];
        this.$.project.githubtoken = user['github-token'];
        this.$.main.gridToken = user['grid-token'];
        this.$.main.user = user['grid-user'];
        this.$.main.avatar = user['grid-avatar'];
        this.$.main.plan = user['flowhub-plan'];
      }
    });
  </script>
</polymer-element>
