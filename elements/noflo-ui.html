<link rel="import" href="noflo-main.html">
<link rel="import" href="../bower_components/the-graph/the-graph-editor/the-graph-editor.html">
<link rel="import" href="noflo-library.html">
<link rel="import" href="noflo-context.html">
<link rel="import" href="noflo-runtime.html">
<link rel="import" href="noflo-journal.html">
<link rel="import" href="noflo-component-editor.html">
<link rel="import" href="noflo-search.html">
<link rel="import" href="noflo-project.html">
<link rel="import" href="noflo-packets.html">
<polymer-element name="noflo-ui" attributes="width height">
  <template>
    <style>
      the-graph-editor {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }

      noflo-component-editor {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 36px;
        right: 0;
        z-index: 0;
      }
    </style>
    <noflo-main id="main"></noflo-main>
    <the-graph-editor id="grapheditor" width="{{ width }}" height="{{ height }}"></the-graph-editor>
    <noflo-library id="library"></noflo-library>
    <noflo-context id="context"></noflo-context>
    <noflo-runtime id="runtime"></noflo-runtime>
    <noflo-journal id="journal"></noflo-journal>
    <noflo-component-editor id="componenteditor" width="{{ width }}" height="{{ height }}"></noflo-component-editor>
    <noflo-search id="search"></noflo-search>
    <noflo-project id="project"></noflo-project>
    <noflo-packets id="packets"></noflo-packets>
  </template>
  <script>
    Polymer('noflo-ui', {
      width: window.innerWidth,
      height: window.innerHeight,
      ctx: {},
      runtimes: function (runtimes) {
        runtimes.forEach(this.$.main.runtimes.bind(this.$.main));
      },
      projects: function (projects) {
        projects.forEach(this.$.main.projects.bind(this.$.main));
      },
      ready: function () {
        this.$.main.addEventListener('logout', function (event) {
          this.fire('user:logout', true);
        }.bind(this));
        this.$.main.addEventListener('login', function (event) {
          this.fire('user:login', true);
        }.bind(this));
        this.$.grapheditor.addEventListener('edges', function (event) {
          this.fire('context:edges', event.detail);
        }.bind(this));
        this.$.grapheditor.addEventListener('nodes', function (event) {
          this.fire('context:nodes', event.detail);
        }.bind(this));
        this.$.project.addEventListener('sync', function (event) {
          this.fire('github:sync:prepare', event.detail);
        }.bind(this));
        this.$.project.addEventListener('syncDecision', function (event) {
          this.fire('github:sync:synchronize', event.detail);
        }.bind(this));
        this.$.componenteditor.addEventListener('change', function (event) {
          this.fire('project:save:component', event.detail);
        }.bind(this));
        this.$.search.addEventListener('search:library', function (event) {
          this.fire('context:search_library', event.detail);
        }.bind(this));
        this.$.search.addEventListener('search:graph', function (event) {
          this.fire('context:search_graph', event.detail);
        }.bind(this));
        this.$.library.addEventListener('result', function (event) {
          this.fire('context:search_library_result', {
            searchLibraryResult: event.detail
          });
        }.bind(this));
        this.$.library.editor = this.$.grapheditor;
        this.$.journal.editor = this.$.grapheditor;
        this.$.context.editor = this.$.grapheditor;
        this.$.packets.editor = this.$.grapheditor;
        this.$.search.editor = this.$.grapheditor;
        this.$.runtime.panel = this.$.context.$.fixed;
        this.$.packets.panel = this.$.context.$.context;
        this.$.search.panel = this.$.context.$.context;
      },
      context: function (context) {
        if (context.state) {
          console.log('CTX is', context);
        }
        for (var key in context) {
          this.ctx[key] = context[key];
        }
        if (context.projects) {
          this.projects(context.projects);
        }
        if (context.runtimes) {
          this.runtimes(context.runtimes);
        }
        if (context.search !== undefined) {
          console.log('CTX search : ' + this.ctx.search);
          this.$.library.search({
            search: this.ctx.search
          });
        }
        if (context.searchLibraryResult) {
          this.$.search.libraryResults(this.ctx.searchLibraryResult);
        }
        if (context.searchGraphResult) {
          this.$.search.graphResults(this.ctx.searchGraphResult);
        }
        if (this.ctx.edges) {
          this.$.packets.edges = this.ctx.edges;
        }
        if (this.ctx.error) {
          this.$.packets.processError(this.ctx.error);
          this.ctx.error = null;
        }
        if (this.ctx.packet) {
          this.$.packets.packet(this.ctx.packet);
          this.ctx.packet = null;
        }
        if (this.ctx.nodes) {
          this.$.context.nodes = this.ctx.nodes;
          this.$.packets.nodes = this.ctx.nodes;
        }
        if (context.nodes || context.edges) {
          return;
        }
        if (context.syncOperation) {
          this.$.project.confirm(context.syncOperation);
          return;
        }
        if (this.ctx.componentDefinition) {
          this.$.grapheditor.registerComponent(this.ctx.componentDefinition);
          this.ctx.componentDefinition = null;
        }
        if (this.ctx.state === 'loading') {
          return;
        }
        if (this.ctx.state === 'error') {
          this.showError(this.ctx);
          return;
        }
        if ((this.ctx.graphs && this.ctx.graphs.length) || this.ctx.component) {
          this.$.main.open = false;
        } else {
          this.$.main.open = true;
        }
        if (this.ctx.graphs && this.ctx.graphs.length) {
          var oldGraph = this.$.grapheditor.graph;
          this.$.grapheditor.graph = this.ctx.graphs[this.ctx.graphs.length - 1];
          this.$.project.graph = this.ctx.graphs[this.ctx.graphs.length - 1];
          this.$.packets.currentgraph = this.ctx.graphs[this.ctx.graphs.length - 1];
          this.$.journal.graph = this.ctx.graphs[this.ctx.graphs.length - 1];
          this.$.runtime.graph = this.ctx.graphs[0];
          if (oldGraph !== this.$.grapheditor.graph) {
            this.fire('context:graph', {
              graph: this.$.grapheditor.graph
            });
          }
        } else {
          this.$.project.graph = null;
          this.$.journal.graph = null;
          this.$.runtime.graph = null;
        }
        if (this.ctx.graphs) {
          this.$.context.graphs = this.ctx.graphs;
          this.$.library.graphs = this.ctx.graphs;
          this.$.project.graphs = this.ctx.graphs;
          this.$.search.graphs = this.ctx.graphs;
        }
        this.$.project.component = this.ctx.component;
        this.$.project.project = this.ctx.project;
        this.$.componenteditor.component = this.ctx.component;
        this.$.search.component = this.ctx.component;
        this.$.search.project = this.ctx.project;
        this.$.runtime.runtimes = this.ctx.compatibleRuntimes;
        this.$.runtime.runtime = this.ctx.runtime;
      },
      user: function (user) {
        this.$.main.githubToken = user['github-token'];
        this.$.main.gridToken = user['grid-token'];
        this.$.main.user = user['grid-user'];
        this.$.main.avatar = user['grid-avatar'];
        this.$.main.plan = user['flowhub-plan'];
      },
      showError: function (ctx) {
      }
    });
  </script>
</polymer-element>
